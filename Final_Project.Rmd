---
title: "EDAV Fall 2019 Final Project"
author: Lin Jiang, Han Xu and Shuo Yang
date: "`r format(Sys.time(), '%d %B, %Y')`"
output:
  html_document:
    toc: yes
  pdf_document:
    latex_engine: xelatex
    number_sections: yes
    toc: yes
  word_document:
    toc: yes
  beamer_presentation:
    fig_width: 6
    toc: yes
urlcolor: blue
---



```{r,echo=FALSE,message=FALSE}
options("digits" = 5)
options("digits.secs" = 3)
 
```

```{r, include=FALSE}
knitr::opts_chunk$set(warning = FALSE, message = FALSE, echo = TRUE, fig.align='center')
```

```{r load packages, include=FALSE}
library(tidyverse)
library(ggplot2)
library(parcoords)
```
# Introdution

Airbnb, . 

Airbnb not only has changed the possibilites of travel and ways of living, but also 
brought new business potetials. We are interested in exploring the data generated from
Airbnb, analyzing the data to find interesting facts about airbnb listing in New York.
We hope we could generate some useful insights to provide guidances for
customers and business suggestions for hosts. 


# Get and Prepare Data

Data source: http://insideairbnb.com/get-the-data.html.

The data source provides a dataset of information from airbnb. We use the most 
recent (Sep, 2019) dataset for New York. The data is not cleaned, so we need to 
spend some time to tidy it. 

The first obstacle is that the data file is relatively large. The csv. file 
downlowded is more than 180MB. So we just select the columns relavent to our analysis.
We also exclude lists that without reviews, as we want to focus on. 

【Another obstacle is that some information is compressed into one cell, like amenities.
Amenities compress all the amenities provided in to one lone string, and it is
not seperated by simple delimiter. We have tried to transform amenities into a 
seperate tidy data frame. We will try to clean other similar columns.】（不用的话可以删了）


Additionally, we define an active list as the onces received reviews within the past 12 months.
Also we only includes data having price larger than zero, since we found that occurence of zero in price 
may due to error in data colleting. 

For the cleaning fee (`cleaning_fee`) and security deposit (`security_deposit`), 
it is intuitive to replace the missings by 0. There are small amount of other variables 
are missing, we simply exclude the listings. It might be also due to collection
error of the original data.

Finally, there are 28098 listings and 62 variables for our analysis.




**amentities for backup**


```{r amenities, eval = FALSE}
#split amenities into tidy data frame
##function to modify amenities string
split_amenities<-function(x){
  #x is an input string
  x<-str_replace_all(x,"[{}]",",") #remove {}
  temp<-str_split(x,"\\\"")[[1]] #split by \"
  temp[str_starts(temp,"[,]") | str_ends(temp,"[,]")]<-str_replace_all(temp[str_starts(temp,"[,]") | str_ends(temp,"[,]")],"[,]","|")
  temp<-str_remove(temp,"^\\|")
  temp<-str_remove(temp,"\\|$")
  temp<-temp[temp!=""]
  out<-paste(temp,collapse = "|")
  return(out)
}

#38 list has no amenities
dat2<-dat1%>%select(id, amenities)%>%
  rowwise()%>%
  mutate(amenity = split_amenities(amenities))
dat3<-dat2%>%separate_rows(amenity,sep="\\|")

##output amenities
#write_csv(dat3%>%select(-amenities),"./data/amenities_201909.csv")
```


# Analysis
```{r include = FALSE, message = FALSE, warning = FALSE}
airbnb_cleaned <- read_csv("data_cleaned.csv")
```

## Price

Booking price is always an important thing both customers and hosts cares about.
In this section, we want to explore the facts of airbnb booking price in
the market of New York. For example, what kind of distribution does the varaible price has. Does 
different areas has different distributions? What is the correlation between price
and other varaibles? 



```{r echo=FALSE, message = FALSE, warning = FALSE}
#Distribution of Price in total
ggplot(data = airbnb_cleaned, aes(x = price)) +
  geom_histogram(bins = 20, aes(y = ..density..), fill = "grey") + geom_density()
  ggtitle("Distribution of Price")
  
  
```


```{r echo=FALSE, message = FALSE, warning = FALSE}
#Distribution of Price in total
ggplot(data = airbnb_cleaned, aes(x = price)) +
  geom_histogram(bins = 20, aes(y = ..density..), fill = "lightblue") + geom_density()+
  scale_x_log10() +
  ggtitle("Distribution of Price (transformed)") 
```

This is a general plot of distribution of price, we could see that it is 
skewed right with very long tail. Thus, we do a log 10 transformation so that we 
could have better visualization. The distribution shows that the median 

```{r echo=FALSE, message = FALSE, warning = FALSE}
#boxplot of price
ggplot() + geom_boxplot(data = airbnb_cleaned, aes(x = "price", y = price))+
  ggtitle("Boxplot of Price")

summary(airbnb_cleaned$price)
```


```{r}
high_price <- airbnb_cleaned %>%
  filter(price > 600)

high_price %>%
  group_by(neighbourhood_group_cleansed) %>%
  summarise(counts = n())

high_price %>%
  group_by(neighbourhood_cleansed) %>%
  summarise(counts = n())%>%
  arrange(desc(counts))


high_price %>%
  group_by(room_type) %>%
  summarise(counts = n())%>%
  arrange(desc(counts))

high_price %>%
  group_by(bedrooms) %>%
  summarise(counts = n()) %>%
  arrange(desc(counts))
```


```{r echo=FALSE}
#Distribution of Price including ckeaning fees 
airbnb_cleaned['total_price'] <- airbnb_cleaned$price + airbnb_cleaned$cleaning_fee


ggplot(data = airbnb_cleaned, aes(x = total_price)) + geom_density()+
  ggtitle("Distribution of Price including cleaning fees")
```

```{r}
ggplot(data = airbnb_cleaned, aes(x = cleaning_fee)) + geom_histogram(binwidth = 2)+
  ggtitle("Distribution of cleaning fees")
```


```{r}
#Price distribution of different room type
ggplot(airbnb_cleaned, aes(x= price, color = room_type)) + geom_density() +
  ggtitle("Price distribution of different room type")

```


```{r}
#Price distribution of different neighborhood 
ggplot(airbnb_cleaned, aes(x= price, color = neighbourhood_group_cleansed)) + geom_density() +
  ggtitle("Price distribution in different neighbourhoods")

```


```{r}
#average price for different area
avg_airbnb <- airbnb_cleaned %>%
  group_by(neighbourhood_group_cleansed) %>%
  summarize(avg_price = mean(price)) %>%
  arrange(desc(avg_price))
colnames(avg_airbnb) <- c("neighbourhood","avg_price" )

  
ggplot(avg_airbnb) + 
  geom_bar(aes(x = reorder(neighbourhood, avg_price), y = avg_price),stat="identity") +
  xlab("Neighbourhood") +
  ggtitle("Average price for different area ")

```

```{r}
avg_airbnb <- airbnb_cleaned %>%
  group_by(neighbourhood_group_cleansed, room_type) %>%
  summarize(avg_price = mean(price)) %>%
  arrange(neighbourhood_group_cleansed) 
 

ggplot(avg_airbnb, aes(x = reorder(neighbourhood_group_cleansed, avg_price), y = avg_price, fill = room_type)) + 
  geom_bar(stat="identity",position = "dodge") + ggtitle("Average price for different neighborhoods with room type")+
  xlab("neighbourhood")

```




```{r}
#Top average price 
avg_airbnb <- airbnb_cleaned %>%
  group_by(airbnb_cleaned$neighbourhood_cleansed) %>%
  summarize(avg_price = mean(price)) %>%
  arrange(desc(avg_price))
colnames(avg_airbnb) <- c("neighbourhood","avg_price" )

  
ggplot(avg_airbnb[1:20,]) + 
  geom_bar(aes(x = reorder(neighbourhood, avg_price), y = avg_price),stat="identity") +
  coord_flip() + ggtitle("Top 20 average price ")

```




```{r}
#Top average price(different room type)
neigh_list <- dplyr::pull(avg_airbnb[1:10,1])

unique(airbnb_cleaned$room_type)
temp <- airbnb_cleaned %>%
  group_by(neighbourhood_cleansed, room_type) %>%
  summarize(avg_price = mean(price)) 

temp %>% filter(room_type == "Private room") %>% arrange(desc(avg_price))

```




## Property type

```{r}
#Distribution of property type
temp <- airbnb_cleaned %>%
  group_by(property_type) %>%
  summarise(counts = n())%>%
  arrange(desc(counts)) %>%
  filter(counts > 5)

ggplot(temp) + 
  geom_bar(aes(x = reorder(property_type, counts),y = counts), stat = 'identity') +  coord_flip() +
             ggtitle("distribution of property type ")

```



## Reviews


## Room type 


## Host 


## Interactive






# Appendix: code

```{r Data Importing and Cleaning, eval = FALSE}
#Data Importing and Cleaning
data <- read_csv ("listings_201909.csv", na=c("","NA","N/A"))

##select columns
dat<-data%>%
  select(-c(scrape_id:xl_picture_url))%>%
  select(-host_url, -host_name, -host_location, -host_about,
         -host_acceptance_rate, -host_thumbnail_url, -host_picture_url, 
         -host_neighbourhood)%>%
  select(-street,-city,-state, -market, -smart_location, -country, 
         -country_code)%>%
  select(-jurisdiction_names, -license,-weekly_price,-monthly_price, 
         -square_feet)%>%
  select(-c(calendar_updated:calendar_last_scraped)) 
#dim(dat)  #48377    62

##modify data type
dat<-dat%>%
  mutate_at(c("host_response_rate","extra_people",
              "price","security_deposit","cleaning_fee"),
            str_remove_all,pattern="[%$]")%>%
  mutate_at(c("host_response_rate","extra_people",
              "price","security_deposit","cleaning_fee"),
            as.numeric)

##select lists which have reviews within the last 12 months
data_cleaned<-dat%>%filter(!is.na(first_review))%>%
  filter(last_review>='2018-09-01')
#dim(dat1) #28105    62

#clean NA
##replace missing values
data_cleaned$cleaning_fee[is.na(data_cleaned$cleaning_fee)] <- 0
data_cleaned$security_deposit[is.na(data_cleaned$security_deposit)] <- 0
data_cleaned<-data_cleaned%>%filter(price>0)

##exclude missing values
completeFun <- function(data, desiredCols) {
  completeVec <- complete.cases(data[, desiredCols])
  return(data[completeVec, ])
}

data_cleaned <- completeFun(data_cleaned, c("review_scores_value", "review_scores_checkin", "review_scores_accuracy", "review_scores_communication", "review_scores_cleanliness","review_scores_rating","neighbourhood", "review_scores_location", "price", "bedrooms", "beds","bathrooms", "host_identity_verified","zipcode"))

#sort(colSums(is.na(data_cleaned)),decreasing = TRUE)

dim(data_cleaned) #28098

#cleaned data output
##write_csv(data_cleaned,"data_cleaned.csv")
```

