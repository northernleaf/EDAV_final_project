---
title: "EDAV Fall 2019 Final Project"
author: Lin Jiang, Han Xu and Shuo Yang
date: "`r format(Sys.time(), '%d %B, %Y')`"
output:
  html_document:
    toc: yes
  pdf_document:
    latex_engine: xelatex
    number_sections: yes
    toc: yes
  word_document:
    toc: yes
  beamer_presentation:
    fig_width: 6
    toc: yes
urlcolor: blue
---



```{r,echo=FALSE,message=FALSE}
options("digits" = 5)
options("digits.secs" = 3)
 
```

```{r, include=FALSE}
knitr::opts_chunk$set(warning = FALSE, message = FALSE, echo = TRUE, fig.align='center')
```

```{r load packages, include=FALSE}
library(tidyverse)
library(ggplot2)
library(parcoords)
library(ggplot2)
library(ggmap)
library(viridis)
library(GGally)

```
# Introdution

Airbnb, . 

Airbnb not only has changed the possibilites of travel and ways of living, but also 
brought new business potetials. We are interested in exploring the data generated from
Airbnb, analyzing the data to find interesting facts about airbnb listing in New York.
We hope we could generate some useful insights to provide guidances for
customers and business suggestions for hosts. 


# Get and Prepare Data

Data source: http://insideairbnb.com/get-the-data.html.

The data source provides a dataset of information from airbnb. We use the most 
recent (Sep, 2019) dataset for New York. The data is not cleaned, so we need to 
spend some time to tidy it. 

The first obstacle is that the data file is relatively large. The csv. file 
downlowded is more than 180MB. So we just select the columns relavent to our analysis.
We also exclude lists that without reviews, as we want to focus on. 

【Another obstacle is that some information is compressed into one cell, like amenities.
Amenities compress all the amenities provided in to one lone string, and it is
not seperated by simple delimiter. We have tried to transform amenities into a 
seperate tidy data frame. We will try to clean other similar columns.】（不用的话可以删了）


Additionally, we define an active list as the onces received reviews within the past 12 months.
Also we only includes data having price larger than zero, since we found that occurence of zero in price 
may due to error in data colleting. 

For the cleaning fee (`cleaning_fee`) and security deposit (`security_deposit`), 
it is intuitive to replace the missings by 0. There are small amount of other variables 
are missing, we simply exclude the listings. It might be also due to collection
error of the original data.

Finally, there are 28098 listings and 62 variables for our analysis. We are interested in
a few areas including Price, Reviews, Room Type, Host Response Rate, etc.
Our analysis answered some interesting questions about Airbnb listings. 



# Analysis
```{r include = FALSE, message = FALSE, warning = FALSE}
airbnb_cleaned <- read_csv("/Users/amber/Downloads/Columbia Related/5702 HW/EDAV_final_project/data/data_cleaned.csv")
```

The majority of listings in our data are among Manhattan and Brooklyn. The closer to the new york city downtown area, the denser the listings. 
```{r echo = FALSE}
## map for listings
data = airbnb_cleaned
data_map_all <- data %>% dplyr::select(id, longitude, latitude)
sbbox <- make_bbox(lon = data_map_all$longitude, lat = data_map_all$latitude, f = .001)

ny_map_all <- get_map(location = sbbox, maptype = "satellite", source = "google")
ggmap(ny_map_all) + 
  geom_point(data = data_map_all, mapping = aes(x = longitude, y = latitude), color = "red", size = 0.0011, alpha = 0.6)

```


## Price
Booking price is always an important factor both customers and hosts care about.
In this section, we want to explore the facts of airbnb booking price in the market of New York. 


### How's Booking Price Distributed?

```{r echo=FALSE, message = FALSE, warning = FALSE}
#Distribution of Price in total
ggplot(data = airbnb_cleaned, aes(x = price)) +
  geom_histogram(bins = 20, aes(y = ..density..), fill = "lightblue") + geom_density()+
  ggtitle("Distribution of Price")
  
  
```


```{r echo=FALSE, message = FALSE, warning = FALSE}
#Distribution of Price in total
ggplot(data = airbnb_cleaned, aes(x = price)) +
  geom_histogram(bins = 20, aes(y = ..density..), fill = "lightblue") + geom_density()+
  scale_x_log10() +
  ggtitle("Distribution of Price (transformed)") +
  geom_vline(xintercept = round(median(airbnb_cleaned$price), 2), size = 1, color = 'red') 
```

The first plot is a general plot of distribution of price, we could see that it is 
skewed right with very long tail. Thus, we do a log 10 transformation so that we 
could have better visualization. The distribution shows that the median of price 
is 100. 

The boxplot in the following also shows that most of the listings have a price
under 200 dollars. There are some listings have ridiculous high prices. 
What are these listings? Why are they so expensive?
Let's further explore these lisitngs with high prices. 


```{r echo=FALSE, message = FALSE, warning = FALSE}
#boxplot of price

ggplot() + geom_boxplot(data = airbnb_cleaned, aes(x = "price", y = price))+
  ggtitle("Boxplot of Price") +
  scale_y_continuous(breaks = c(0, 100, 200, 300,400,500,600,700,800,900,1000)) +
  coord_flip()


```

### What Makes Some Listings Most Expensive?


```{r echo = FALSE, fig.width= 10}
high_price <- airbnb_cleaned %>%
  filter(price > 600)


require(gridExtra)

plot1 <- high_price %>%
  group_by(neighbourhood_group_cleansed) %>%
  summarise(counts = n()) %>%
  arrange(desc(counts))%>%
  
  
  ggplot() + geom_bar(aes(x = reorder(neighbourhood_group_cleansed, counts), y = counts), 
                      stat = 'identity', fill = '#3CA9FC') + xlab("neighbourhood") + ggtitle('Neighbourhood counts of listing with 600+ price')



plot2 <- high_price %>%
  group_by(neighbourhood_cleansed) %>%
  summarise(counts = n())%>%
  arrange(desc(counts)) %>%
  filter(counts > 8) %>%
 ggplot() + geom_bar(aes(x = reorder(neighbourhood_cleansed, counts), y = counts), 
                      stat = 'identity', fill = '#3CA9FC') + xlab("neighbourhood") + 
  coord_flip() + ggtitle('Deatails of Neighbourhood')

grid.arrange(plot1, plot2, ncol=2)
```
We foucus on the listings with price more than $600. We could see that most of the
listings belongs to Manhattan area, which is reasonable. Futhermore, most of the listings 
with high price are in Midtown, which is also not unexpected, because Midtown is 
the central portion of Manhattan.



```{r, echo = FALSE, fig.width= 10}
plot1 <- high_price %>%
  group_by(room_type) %>%
  summarise(counts = n())%>%
  arrange(desc(counts)) %>%
  ggplot() + geom_bar(aes(x = reorder(room_type, counts), y = counts), 
                      stat = 'identity',  fill = '#3CA9FC') + xlab("room_type") + 
  coord_flip() + ggtitle('Room type ') 


plot2 <- high_price %>%
  group_by(bedrooms) %>%
  summarise(counts = n()) %>%
  arrange(desc(counts)) %>% 
    ggplot() + geom_bar(aes(x = reorder(bedrooms, counts), y = counts), 

                      stat = 'identity',fill = '#3CA9FC') + xlab('number of bedrooms')+

  coord_flip() + ggtitle('Number of bedrooms ') 
  


grid.arrange(plot1, plot2, ncol=2)
```

Moreover, we find the room type of most of these listings with high price is entire
home/apt and the number of bedrooms are about 2-4. This result may explain the high
price of these listings. Booking a big apratment in Midtown of Manhattan is reasonable to 
be expensive. 




### Does Location Make a Difference?
Based on the price distribution above, we are interested in how prices are affected by different locations. We plotted the below push pin map which shows the price distribution among new york districts. 
```{r echo = FALSE}
## map for different price
ny_price <- data %>% mutate(price_group = 
         case_when(price <= 100 ~ '$100', 
                   price <= 250 ~ '$100-$250',
                   price <= 500 ~ '$250-$500',
                   TRUE ~ '>$500')) 
ny_price$price_group <- factor(ny_price$price_group, levels = c('$100',  '$100-$250', '$250-$500', '>$500'))

data_map_price <- ny_price %>% select(id, longitude, latitude, price_group)
sbbox3 <- make_bbox(lon = data_map_price$longitude, lat = data_map_price$latitude, f = .001)

ny_map_price <- get_map(location = sbbox3, maptype = "satellite", source = "google")
ggmap(ny_map_price) + 
  geom_point(data = data_map_price, mapping = aes(x = longitude, y = latitude, color = price_group), size = 1, alpha = 0.5) +
  scale_color_brewer(palette = "Dark2") + 
  ggtitle("Listings by Price Range")

```
Most of the listings are among $100-$250 per night and the closer we are to new york downtown, the higher the price. The purple points indicate expensive listings above $250 per night. We can rarely see listings that cost more than $500 per night.

Indeed, price is largely affected by location. To better illustrate, we plotted the average price per night for the five neighborhoods.


```{r echo = FALSE}
#average price for different area
avg_airbnb <- airbnb_cleaned %>%
  group_by(neighbourhood_group_cleansed) %>%
  summarize(avg_price = mean(price)) %>%
  arrange(desc(avg_price))
colnames(avg_airbnb) <- c("neighbourhood","avg_price" )

  
ggplot(avg_airbnb) + 
  geom_bar(aes(x = reorder(neighbourhood, avg_price), y = avg_price),stat="identity", fill = '#3CA9FC') +
  xlab("Neighbourhood") +
  ggtitle("Average price for different area ")

```

We can see that Bronx, Staten Island, Queens are almost the same. Brooklyn and Manhattan are more expensice by about $50 to $100 per night, which is a large amount considering our majority of the prices are around $100 per night. 

```{r echo = FALSE}
#Price distribution of different neighborhood 
ggplot(airbnb_cleaned, aes(x= price, color = neighbourhood_group_cleansed)) + geom_density() +
   scale_x_log10() +
  ggtitle("Price distribution in different neighbourhoods (transformed)")+
  scale_color_brewer(palette = "Dark2")

```

The price distribution for different neighborhoods share the same shape. They have relatively the same variance but different mean, which corresponds to our previous observation. 

### Are Deposite and Cleaning Fee Proportional to Price?

When we are browing through different listings, the price that Airbnb site displays does not include the deposite needed or the cleaning fee. We are interested in whether the deposit and cleaning fee are proportional to the listing price because intuitively we think they are. 

```{r echo = FALSE}

plot1 <- ggplot(data = airbnb_cleaned, aes(x = cleaning_fee)) + 
  geom_histogram(aes(y=..density..),binwidth = 20, color = 'white', fill = '#3CA9FC')+
  geom_density() +
  ggtitle("Distribution of cleaning fees($)")

```
```{r}
plot2 <-ggplot(data = airbnb_cleaned, aes(x = security_deposit)) + 
  geom_histogram(aes(y=..density..),binwidth = 50, color = 'white', fill = '#3CA9FC')+
  geom_density() +
  ggtitle("Distribution of security deposit($)")

```


```{r}
require(gridExtra)

grid.arrange(plot1, plot2, ncol=2)

```

There is only a few of listings with 0 cleaning fees and almost all of them are within $200, which is a pretty high range considering our median listing price per night is $100. There's only 3% of the listings do not require security deposit and surprisingly there are about 0.25% (about 7000 listings) with security deposit of $500. 

We use scatter plots to explore the relationship between price and cleaning fee and security deposit. 

```{r echo=FALSE}
# Scatter plot of price vs cleaning fee
temp <- airbnb_cleaned[sample(nrow (airbnb_cleaned)), ] 

plot1 <- ggplot(temp,aes(x = price, y = cleaning_fee)) + 
  geom_point(color = '#3CA9FC', alpha = 0.5) +
  ggtitle("Price vs Cleaning Fee") +scale_color_brewer(palette = "Dark2")

plot2 <- ggplot(temp,aes(x = price, y = security_deposit)) + 
  geom_point(color = '#3CA9FC', alpha = 0.5) +
  ggtitle("Price vs Security Deposit") +scale_color_brewer(palette = "Dark2")

require(gridExtra)

grid.arrange(plot1, plot2, ncol=2)

```


We did not observe any obvious pattern with price vs cleaning fee or price vs security deposit. For the scatterplot of price vs security deposit, there are some horizontal lines because security deposit tend to be set to integers so the "lines" appear because they are discrete data. 

### Does Room Type Affect Price?
Room type is also an important factor customers care about. 
There are four room types in Airbnb market: entire home/apt, private room, 
shared room, and hotel room.


```{r echo = FALSE}
#Price distribution of different room type
ggplot(airbnb_cleaned, aes(x= price, color = room_type)) + geom_density() +
   scale_x_log10() +
  ggtitle("Price distribution of different room type (transformed)") + scale_color_brewer(palette = "Dark2")

```

First, we take a look at the price distribution for different room type. We could 
see that entire home/apt and hotel/room have realative higher price than private room 
and shared room, which is reasonable. Additionally, shared room has realtive lowest price in the market. These findings does not violate our common sense. We continue exploring the price distribution 
for different room type in four neighbourhoods.



```{r echo = FALSE}
avg_airbnb <- airbnb_cleaned %>%
  group_by(neighbourhood_group_cleansed, room_type) %>%
  summarize(avg_price = mean(price)) %>%
  arrange(neighbourhood_group_cleansed) 

ggplot(avg_airbnb, aes(x = reorder(neighbourhood_group_cleansed, avg_price), y = avg_price, fill = room_type)) + 
  geom_bar(stat="identity",position = "dodge") + ggtitle("Average price for different neighborhoods with room type")+
  xlab("neighbourhood") + scale_color_brewer(palette = "Dark2")

```
From the graph, we could find that in Manhattan, hotel room has the highest average price. 
Also, we could see that entire room/apt always much higher than private room and shared
room. The price for entire room/apt is relatively very high in Manhattan. 
Therefore, if customers has limited budgets, it is not wise to look for hotels and entire home/apt 
in Manhattan. 
For shared room, Brooklyn and Bronx has the lowest average price.
For entire home/apt and private room, Staten Island has the lowest average price. 




```{r echo=FALSE, message = FALSE, warning = FALSE}
## map for different room types
data_map_room <- data[sample(nrow(data)),] %>% select(id, longitude, latitude, room_type)
sbbox1 <- make_bbox(lon = data_map_room$longitude, lat = data_map_room$latitude, f = .001)

ny_map_room <- get_map(location = sbbox1, maptype = "satellite", source = "google")
ggmap(ny_map_room) + 
  geom_point(data = data_map_room, mapping = aes(x = longitude, y = latitude, color = room_type), size = 1, alpha = 0.5) + 

  scale_fill_brewer(palette = "Dark2") + 
  ggtitle("Listings by Room Type")

```

Surprisingly, at such an expensive living area like Manhattan, lots of listings 
are "Entire Home/Apt". It's true that Manhattan has the most expensive listings 
but they actually also have relative good qualities (instead of being all
shared rooms and small private rooms).


### Does Property Type Affect Price?


We use a stacked bar chart to show the proportion of different property type of listings across five neiborhoods. 


```{r echo = FALSE, message = FALSE, warning = FALSE}
temp <- dplyr::summarise(group_by(airbnb_cleaned, property_type, neighbourhood_group_cleansed), freq = n())  %>% filter(freq > 70)

df2 <- temp %>%
group_by(neighbourhood_group_cleansed) %>%
mutate(prop = freq/sum(freq)) %>%
ungroup()

ggplot(df2, aes(x = neighbourhood_group_cleansed, y = prop*100, fill = property_type)) +
geom_bar(stat = "identity") + labs(x = "Neighborhood",
y = "Proportion (%)",

title = "Neighborhood by Property Type") +
theme(legend.title = element_blank()) + 
  scale_fill_brewer(palette = "Dark2")

```


Most of the listings are Apartments, followed by House. Manhattan has the most aprtments and Staten Island has the most House. Interestingly, Manhatton barely has any Houses, which makes sense because Manhattan has super high population density and has a lot more Apartments in order to hold more people. We can also observe that Manhatton, Brooklyn and Queens listings have a bigger variety in property types, including Loft and even Townhouse. 

```{r echo = FALSE}

## map for different property type
data_map_property <- data[sample(nrow(data)),] %>% filter(property_type %in% c('Apartment', 'House', 'Townhouse', 'Condominium', 'Loft','Guest suite', 'Serviced apartment', 'Hotel')) %>% select(id, longitude, latitude, property_type)
sbbox2 <- make_bbox(lon = data_map_property$longitude, lat = data_map_property$latitude, f = .001)

ny_map_property <- get_map(location = sbbox2, maptype = "satellite", source = "google")
ggmap(ny_map_property) + 
  geom_point(data = data_map_property, mapping = aes(x = longitude, y = latitude, color = property_type), size = 1, alpha = 0.5) + 
  scale_fill_brewer(palette = "Dark2") +
  ggtitle("Listings by Property Type")

```


As observed before, the majority are Apartments and Hotels. The closer to the center of the New York downtown area, the more apartments and less houses we have. 

###  Are There any Correlation Between Price and Other Variables?
Other variables may be important factors that affects price, such as 
number of reveiws, number of minimum night, host response rate, and review scores rating.
However, from the pairwise scatter plot, we could see that price actually does not 
have strong correlation with these variables. 
The price is set by hosts and not every host have multiple financial and marketing information.
Additionally, not all the host's purpose is making money, so price may not reflect actual market values.
Price setting is individual subjective. 
Therefore, we could see that a high price does not guarantee a good services. 


```{r echo=FALSE, message = FALSE, warning = FALSE}
#price vs number_of_reveiws, minimum_night, host_response_rate, review_scores_rating
pairPlot <- airbnb_cleaned[,c("price", "number_of_reviews", "minimum_nights", "host_response_rate", "review_scores_rating") ]
ggpairs(pairPlot)

```

There are other variables may be important factors that affects price, such as 
number of reveiws, number of minimum night, host response rate, and review scores rating.
However, from the pairwise scatter plot, we could see that price actually does not 
have strong correlation with these variables. 
The price is set by hosts and not every host have multiple financial and marketing information.
Additionally, not all the host's purpose is making money, so price may not reflect actual market values.
Price setting is individual subjective. 
Therefore, we could see that a high price does not guarantee a good services. 


```{r echo=FALSE, message = FALSE, warning = FALSE}
#price vs number_of_reveiws, minimum_night, host_response_rate, review_scores_rating
pairPlot <- airbnb_cleaned[,c("price", "number_of_reviews", "minimum_nights", "host_response_rate", "review_scores_rating") ]
ggpairs(pairPlot)

```

## Reviews

### How to Better Understand Customer Reviews?

Analyzing reviews can provide customers' opinions of valuaing the quality of airbnb
services. Customers can rate an Airbnb stay in six categories: cleanliness, accuracy, 
checking, communication, location, and value which we think represent an overall experience of the stay. 

It is useful to explore which category affects the "value rating" the most because we see high "value" being that customers have the best experience during their stay. Knowing what
customers' care can help hosts to understand what they can focus on improving to provide better service and attract more customers.  


We plotted this bar chart to represent the full score percentage in each of the scoring categories. 
```{r echo = FALSE,  message = FALSE, warning = FALSE, fig.width= 15}
dat_review<- airbnb_cleaned%>%
  dplyr::select(starts_with("review"))%>%
  dplyr::select(2:7)

colnames(dat_review)<-gsub("review_scores_","",colnames(dat_review))
dat_review<-dat_review%>%
  gather(key=others,value="scores",-value)

ggplot(dat_review)+
  geom_bar(aes(x=fct_reorder(others,scores==10,sum),
               fill=others,alpha=scores==10),position='fill')+
  coord_flip()+
  scale_alpha_discrete(range=c(0.5,1))+
  scale_fill_brewer(palette = "Dark2")+
  labs(y="",x="",
       title="Full Review Score% by Scoring Category",
       alpha="Score of 10",
       fill="Review Score")+
  theme(axis.text.x =element_text(size=19),
         axis.text.y=element_text(size=15),
        axis.title=element_text(size=14,face="bold"))

```
We can see that about 80% of the listings has full score in cleaning and checkin, meaning most of the customers are most satisfied with these two categories. It's worth noticing that the least customers tend to give full rating score to "Cleaning" category, meaning this might be one factor that hosts in New York need to pay more attention to. 

```{r}


ggplot(dat_review%>%filter(scores==10)%>%
         group_by(others,value==10)%>%
         dplyr::summarise(n=sum(value))%>%
         ungroup()%>%group_by(others)%>%
         mutate(perc=n/sum(n))%>%
         ungroup()%>%mutate(value=`value == 10`))+
  geom_bar(aes(x=fct_reorder(others,perc,max),y=perc,
               fill=others,
               alpha=value),
           position='fill',
           stat="identity")+
  coord_flip()+
  scale_alpha_discrete(range=c(0.5,1))+
  scale_fill_brewer(palette = "Dark2")+
  labs(y="",x="",
       title="Full \"Value\" Review Score% Given Full Score in Each Scoring Category",
       alpha="Score of 10\nin Value",
       fill="Review Score") +
  theme(axis.text.x=element_text(size=19),
        axis.text.y=element_text(size=15),
        axis.title=element_text(size=14,face="bold"))
```

Notice that this is the percentage of full "value" score given full score in each of these scoring categories. Therefore, the higher means customers are satisfied with this category along with "value" category, which implies they have better overall experience during their stay. 

In addition to this, accurary tend to affect how customer evaluate the "value" of their trip. Combining these two, we can say that "Cleaning" and "Accuracy" tend to have higher impact on customer's overall experience of their trip. 

Therefore, we suggest that hosts should pay attention to cleaning of their rooms 
and they should not give exaggerated descriptions to their listings. 

## Interactive



# Conclusion
From this analysis, we 



# Appendix: code

```{r Data Importing and Cleaning, eval = FALSE}
#Data Importing and Cleaning
data <- read_csv ("listings_201909.csv", na=c("","NA","N/A"))

##select columns
dat<-data%>%
  select(-c(scrape_id:xl_picture_url))%>%
  select(-host_url, -host_name, -host_location, -host_about,
         -host_acceptance_rate, -host_thumbnail_url, -host_picture_url, 
         -host_neighbourhood)%>%
  select(-street,-city,-state, -market, -smart_location, -country, 
         -country_code)%>%
  select(-jurisdiction_names, -license,-weekly_price,-monthly_price, 
         -square_feet)%>%
  select(-c(calendar_updated:calendar_last_scraped)) 
#dim(dat)  #48377    62

##modify data type
dat<-dat%>%
  mutate_at(c("host_response_rate","extra_people",
              "price","security_deposit","cleaning_fee"),
            str_remove_all,pattern="[%$]")%>%
  mutate_at(c("host_response_rate","extra_people",
              "price","security_deposit","cleaning_fee"),
            as.numeric)

##select lists which have reviews within the last 12 months
data_cleaned<-dat%>%filter(!is.na(first_review))%>%
  filter(last_review>='2018-09-01')
#dim(dat1) #28105    62

#clean NA
##replace missing values
data_cleaned$cleaning_fee[is.na(data_cleaned$cleaning_fee)] <- 0
data_cleaned$security_deposit[is.na(data_cleaned$security_deposit)] <- 0
data_cleaned<-data_cleaned%>%filter(price>0)

##exclude missing values
completeFun <- function(data, desiredCols) {
  completeVec <- complete.cases(data[, desiredCols])
  return(data[completeVec, ])
}

data_cleaned <- completeFun(data_cleaned, c("review_scores_value", "review_scores_checkin", "review_scores_accuracy", "review_scores_communication", "review_scores_cleanliness","review_scores_rating","neighbourhood", "review_scores_location", "price", "bedrooms", "beds","bathrooms", "host_identity_verified","zipcode"))

#sort(colSums(is.na(data_cleaned)),decreasing = TRUE)

dim(data_cleaned) #28098

#cleaned data output
##write_csv(data_cleaned,"data_cleaned.csv")
```

#Get Amenities data
```{r amenities, eval = FALSE}
#split amenities into tidy data frame
##function to modify amenities string
split_amenities<-function(x){
  #x is an input string
  x<-str_replace_all(x,"[{}]",",") #remove {}
  temp<-str_split(x,"\\\"")[[1]] #split by \"
  temp[str_starts(temp,"[,]") | str_ends(temp,"[,]")]<-str_replace_all(temp[str_starts(temp,"[,]") | str_ends(temp,"[,]")],"[,]","|")
  temp<-str_remove(temp,"^\\|")
  temp<-str_remove(temp,"\\|$")
  temp<-temp[temp!=""]
  out<-paste(temp,collapse = "|")
  return(out)
}

#38 list has no amenities
dat2<-dat1%>%select(id, amenities)%>%
  rowwise()%>%
  mutate(amenity = split_amenities(amenities))
dat3<-dat2%>%separate_rows(amenity,sep="\\|")

##output amenities
#write_csv(dat3%>%select(-amenities),"./data/amenities_201909.csv")
```