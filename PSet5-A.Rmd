---
title: "EDAV Fall 2019 PSet 5, part A"
author: Lin Jiang, Han Xu and Shuo Yang
output:
  html_document:
    df_print: paged
---
```{r, include=FALSE}
knitr::opts_chunk$set(warning = FALSE, message = FALSE, echo = TRUE, fig.align='center')
```

```{r load packages}
library(tidyverse)
library(ggplot2)
library(parcoords)
```


This assignment is designed to help you get started on the final project. Be sure to review the final project instructions (https://edav.info/project.html), in particular the new section on reproducible workflow (https://edav.info/project.html#reproducible-workflow), which summarizes principles that we've discussed in class.
    
### 1. The Team

[2 points]

a) Who's on the team? (Include names and UNIs)

Han Xu(hx2282), Shuo Yang(sy2886), Lin Jiang(lj2493).

b) How do you plan to divide up the work? (Grading is on a group basis. The point of asking is to encourage you to think about this.)

We will have brain storming to get ideas and questions together. 
Han Xu is responsible for data cleaning and data analyze 
Shuo Yang is responsible for data visualization. 
Lin Jiang is responsible for data visualization and making slides for presentation. 

### 2. The Questions

[6 points]

List three questions that you hope you will be able to answer from your research.

For the lists on Airbnb in New York City:

a) What's the trend between price, host response rate, bed type and avg review/number of reviews?

b) Do the cleaning fee and deposit affect the price?

c) Is there any relationship between district and room type/price. 

### 3. Which output format do you plan to use to submit the project? 

[2 points]

(You don't have to use the same format for this assignment -- PSet 5, part A -- and the final project itself.)

Choices are:

pdf_document  

html_document  

bookdown book: https://bookdown.org/yihui/bookdown/

shiny app: https://shiny.rstudio.com/  

(Remember that it's ok to have pieces of the project that don't fit into the chosen output format; in those cases you can provide links to the relevant material.)


We plan to make html_document. 



### 4. The Data

What is your data source?  What is your method for importing data? Please be specific. Provide relevant information such as any obstacles you're encountering and what you plan to do to overcome them.

[5 points]

Data source: http://insideairbnb.com/get-the-data.html
The data source provides a dataset of information from airbnb. We plan to use the the most recent (Sep, 2019) dataset for New York. The dataset is csv file, so we could just download and read it in normally. 
The data is not cleaned, so we need spend some time to tidy it. 

- The first obstacle is that the data file is  relatively large. The csv. file downlowded is more than 180MB. So we just select the columns relavent to our analysis. We also exclude lists that without reviews, as we want to focus on
- Another obstacle is that some information is compressed into one cell, like amenities. Amenities compress all the amenities provided in to one lone string, and it is not seperated by simple delimiter. We have tried to transform amenities into a seperate tidy data frame. We will try to clean other similar columns.


```{r Data Importing and Cleaning}
#Data Importing and Cleaning
data<-read_csv("listings_201909.csv", na=c("","NA","N/A"))

##select columns
dat<-data%>%
  select(-c(scrape_id:xl_picture_url))%>%
  select(-host_url, -host_name, -host_location, -host_about,
         -host_acceptance_rate, -host_thumbnail_url, -host_picture_url, 
         -host_neighbourhood)%>%
  select(-street,-city,-state, -market, -smart_location, -country, 
         -country_code)%>%
  select(-jurisdiction_names, -license,-weekly_price,-monthly_price, 
         -square_feet)%>%
  select(-c(calendar_updated:calendar_last_scraped)) 

#dim(dat)  #48377    62

##modify data type
dat<-dat%>%
  mutate_at(c("host_response_rate","extra_people",
              "price","security_deposit","cleaning_fee"),
            str_remove_all,pattern="[%$]")%>%
  mutate_at(c("host_response_rate","extra_people",
              "price","security_deposit","cleaning_fee"),
            as.numeric)

##select lists which have reviews
dat1<-dat%>%filter(!is.na(first_review))
#dim(dat1) #38726    62

##output initial working data
#write_csv(dat1,"./data/airbnb_201909.csv")
```


```{r amenities}
#split amenities into tidy data frame
##function to modify amenities string
split_amenities<-function(x){
  #x is an input string
  x<-str_replace_all(x,"[{}]",",") #remove {}
  temp<-str_split(x,"\\\"")[[1]] #split by \"
  temp[str_starts(temp,"[,]") | str_ends(temp,"[,]")]<-str_replace_all(temp[str_starts(temp,"[,]") | str_ends(temp,"[,]")],"[,]","|")
  temp<-str_remove(temp,"^\\|")
  temp<-str_remove(temp,"\\|$")
  temp<-temp[temp!=""]
  out<-paste(temp,collapse = "|")
  return(out)
}

#38 list has no amenities
dat2<-dat1%>%select(id, amenities)%>%
  rowwise()%>%
  mutate(amenity = split_amenities(amenities))
dat3<-dat2%>%separate_rows(amenity,sep="\\|")

##output amenities
#write_csv(dat3%>%select(-amenities),"./data/amenities_201909.csv")
```


### 5. Provide a short summary, including 2-3 graphs, of your initial investigations. 

[10 points]

**Bar Chart - Listings by Neighborhood**
```{r}
data <- read_csv("./data/airbnb_201909.csv")

data_by_region <- data %>%
  group_by(neighbourhood_group_cleansed) %>%
  summarize(count = n()) %>%
  mutate(prop = count/sum(count)) %>%
  ungroup()

ggplot(data_by_region, aes(x=fct_reorder(neighbourhood_group_cleansed,count), y=count)) +
  geom_bar(stat = "identity", fill = "lightblue", color = "black") +
  labs(x = 'Neighborhood',
       y = 'Listings',
       title = 'Listings by Neighborhood') +
  coord_flip()

```

The majority of the listings are in Brooklyn and Manhattan. 

**Histogram - Listing Price Range**
```{r}
ggplot(data, aes(x=price)) + 
  geom_histogram(bins = 15, 
                 col = "black",
                 fill = 'lightblue') + 
  labs(x = 'Price',
       y = 'Listings',
       title = 'Listing Price Range')
```

We see that the majority of listings are between $100 to $250 per night. 

**Parallel Coordinates - Initial Investigation**
```{r}
data_parallel <- data %>%
  dplyr::select(price, host_response_rate, bed_type, review_scores_rating, number_of_reviews, neighbourhood_group_cleansed) %>%
  filter(data$first_review > 2019-01-01) %>%
  filter(!is.na(price) & !is.na(host_response_rate) & !is.na(review_scores_rating)) 

names(data_parallel)[names(data_parallel) == 'neighbourhood_group_cleansed'] <- 'neighbourhoodColor'

parcoords(data_parallel, 
          color = list(
          colorBy = "neighbourhoodColor"
          , colorScale = "scaleOrdinal"
          , colorScheme = "schemeCategory10"
          ),
          withD3 = TRUE,
          reorderable = TRUE,
          alpha = 0.5, 
          brushMode = "1d-axes")
```

For initial investigation, we are interested in the relationship between price, host response rate, bed type, review score and number of ratings. After plotting the parallel coordinates for different neighborhoods, we see that Staten Island and Bronx share similar patterns, they have low price ranges, high host response rate, primarily real beds, high review scores and less reviews. Brooklyn and Queens share similar patterns, they have higher prices, varying host response rate and bed types, medium to high review scores and more reviews. For Manhattan, the patterns vary a lot. For example, we have prices ranging from super cheap to extermely expensive. And we also have all kinds of bed types like airbed and couch. This initial observation makes sense because we have lots of data for Manhattan and depending on the actual location in Manhattan, the listings could differ a lot. 

For the next steps, we will need to divide up the actual prices/response rates/reviews scores into smaller groups for better comparision to figure out the relationships between these factors. 

**Bar Plot and Histogram - Amenities**
```{r initial amenities}
##most commom amenities
df_am<-read_csv("./data/amenities_201909.csv")

ggplot(df_am%>%group_by(amenity)%>%count()%>%ungroup%>%arrange(-n)%>%head(20))+
  geom_col(aes(x=fct_reorder(amenity,n),y=n), col = "black",
           fill = 'lightblue')+
  coord_flip()+
  labs(title="Most Common 20 Amenities", y="Count",x="Amenities")

##most equipted list
ggplot(df_am%>%group_by(id)%>%count()%>%ungroup)+
  geom_histogram(aes(x=n),binwidth = 2, boundary = 0, closed = "right",
                 col = "black",
                 fill = 'lightblue')+
  labs(title="Histogram of Number of Amenities Provided by Each List", y="Count",x="Number of Amenities")

```

The bar plot lists out the most commomly listed amenities. It is not surprise to see that Wifi is on the top of amenities. The histogram shows the distribution of number of amenities for each list. Some of the lists are very detailed about what they provide, thus the plot is right skewed. Most commonly, a list will highlight around 15 amenities they provide. It will be interesting to investigate the relationship of price and reviews with the number of amenities and the content of the amenities.