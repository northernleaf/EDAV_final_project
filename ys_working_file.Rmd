---
title: "DataCleaning"
author: "YS"
date: "11/19/2019"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r load library}
library(tidyverse)
```


# data cleaning

We obtained the most recent available raw Airbnb data for New York City from http://insideairbnb.com/get-the-data.html. The csv. file is more than 180MB

```{r}
#data<-read_csv("listings_201909.csv", na=c("","NA","N/A"))
data<-read_csv(file.choose(), na=c("","NA","N/A"))

dat<-data%>%
  select(-c(scrape_id:xl_picture_url))%>%
  select(-host_url, -host_name, -host_location, -host_about, -host_acceptance_rate, -host_thumbnail_url, -host_picture_url, -host_neighbourhood)%>%
  select(-street,-city,-state, -market, -smart_location, -country, -country_code)%>%
  select(-jurisdiction_names, -license,-weekly_price,-monthly_price, -square_feet)%>%
  select(-c(calendar_updated:calendar_last_scraped)) 

dim(dat)  #48377    62

dat<-dat%>%
  mutate_at(c("host_response_rate","extra_people","price","security_deposit","cleaning_fee"),str_remove_all,pattern="[%$]")%>%
  mutate_at(c("host_response_rate","extra_people","price","security_deposit","cleaning_fee"),as.numeric)


dat1<-dat%>%filter(!is.na(first_review))
dim(dat1) #38726    62

write_csv(dat1,"./data/airbnb_201909.csv")
```

```{r amenities}
split_amenities<-function(x){
  #x is a string
  ##modify to list
  x<-str_replace_all(x,"[{}]",",") #remove {}
  temp<-str_split(x,"\\\"")[[1]] #split by \"
  temp[str_starts(temp,"[,]") | str_ends(temp,"[,]")]<-str_replace_all(temp[str_starts(temp,"[,]") | str_ends(temp,"[,]")],"[,]","|")
  temp<-str_remove(temp,"^\\|")
  temp<-str_remove(temp,"\\|$")
  temp<-temp[temp!=""]
  out<-paste(temp,collapse = "|")
  return(out)
}

#id==57166
#38 list has no amenities
dat2<-dat1%>%select(id, amenities)%>%
  rowwise()%>%
  mutate(amenity = split_amenities(amenities))
dat3<-dat2%>%separate_rows(amenity,sep="\\|")

length(unique(dat3$amenity))  #130, including 1 "" for lists with no amenities

write_csv(dat3%>%select(-amenities),"./data/amenities_201909.csv")

##most commom amenities
dat3%>%group_by(amenity)%>%count()%>%ungroup%>%arrange(-n) #top 10, Wifi #1
dat3%>%group_by(amenity)%>%count()%>%ungroup%>%arrange(n)
library(ggplot2)
ggplot(dat3%>%group_by(amenity)%>%count()%>%ungroup)+
  geom_col(aes(x=fct_reorder(amenity,n),y=n))+
  coord_flip()

dat3%>%filter(grepl("Washer",amenity))%>%group_by(amenity)%>%count() #15097:9
dat3%>%filter(grepl("Dryer",amenity))%>%group_by(amenity)%>%count() #14839:9

##most equipted list
dat3%>%group_by(id)%>%count()%>%arrange(-n) #77-67


##translation missing
dat3%>%filter(grepl("translation",amenity))%>%group_by(amenity)%>%count()  #2 types
#id 5099 5178

```


```{r}
colSums(is.na(df))
```

### 4. The Data

What is your data source?  What is your method for importing data? Please be specific. Provide relevant information such as any obstacles you're encountering and what you plan to do to overcome them.

[5 points]

Data source: http://insideairbnb.com/get-the-data.html
The data source provides a dataset of information from airbnb. We plan to use the the most recent (Sep, 2019) dataset for New York. The dataset is csv file, so we could just download and read it in normally. 
The data is not cleaned, so we need spend some time to tidy it. 

- The first obstacle is that the data file is  relatively large. The csv. file downlowded is more than 180MB. So we just select the columns relavent to our analysis. We also exclude lists that without reviews, as we want to focus on
- Another obstacle is that some information is compressed into one cell, like amenities. Amenities compress all the amenities provided in to one lone string, and it is not seperated by simple delimiter. We have tried to transform amenities into a seperate tidy data frame. We will try to clean other similar columns.


```{r load packages}
library(tidyverse)
library(ggplot2)
```

```{r Data Importing and Cleaning}
#Data Importing and Cleaning
data<-read_csv("listings_201909.csv", na=c("","NA","N/A"))

##select columns
dat<-data%>%
  select(-c(scrape_id:xl_picture_url))%>%
  select(-host_url, -host_name, -host_location, -host_about,
         -host_acceptance_rate, -host_thumbnail_url, -host_picture_url, 
         -host_neighbourhood)%>%
  select(-street,-city,-state, -market, -smart_location, -country, 
         -country_code)%>%
  select(-jurisdiction_names, -license,-weekly_price,-monthly_price, 
         -square_feet)%>%
  select(-c(calendar_updated:calendar_last_scraped)) 

#dim(dat)  #48377    62

##modify data type
dat<-dat%>%
  mutate_at(c("host_response_rate","extra_people",
              "price","security_deposit","cleaning_fee"),
            str_remove_all,pattern="[%$]")%>%
  mutate_at(c("host_response_rate","extra_people",
              "price","security_deposit","cleaning_fee"),
            as.numeric)

##select lists which have reviews
dat1<-dat%>%filter(!is.na(first_review))
#dim(dat1) #38726    62

##output initial working data
#write_csv(dat1,"./data/airbnb_201909.csv")
```


```{r amenities}
#split amenities into tidy data frame
##function to modify amenities string
split_amenities<-function(x){
  #x is an input string
  x<-str_replace_all(x,"[{}]",",") #remove {}
  temp<-str_split(x,"\\\"")[[1]] #split by \"
  temp[str_starts(temp,"[,]") | str_ends(temp,"[,]")]<-str_replace_all(temp[str_starts(temp,"[,]") | str_ends(temp,"[,]")],"[,]","|")
  temp<-str_remove(temp,"^\\|")
  temp<-str_remove(temp,"\\|$")
  temp<-temp[temp!=""]
  out<-paste(temp,collapse = "|")
  return(out)
}

#38 list has no amenities
dat2<-dat1%>%select(id, amenities)%>%
  rowwise()%>%
  mutate(amenity = split_amenities(amenities))
dat3<-dat2%>%separate_rows(amenity,sep="\\|")

##output amenities
#write_csv(dat3%>%select(-amenities),"./data/amenities_201909.csv")
```


### 5. Provide a short summary, including 2-3 graphs, of your initial investigations. 

[10 points]

```{r initial amenities}
##most commom amenities
df_am<-read_csv("./data/amenities_201909.csv")

ggplot(df_am%>%group_by(amenity)%>%count()%>%ungroup%>%arrange(-n)%>%head(20))+
  geom_col(aes(x=fct_reorder(amenity,n),y=n))+
  coord_flip()+
  labs(title="Most Common 20 Amenities", y="Count",x="Amenities")

##most equipted list
ggplot(df_am%>%group_by(id)%>%count()%>%ungroup)+
  geom_histogram(aes(x=n),binwidth = 2, boundary = 0, closed = "right",  fill="blue")+
  labs(title="Histogram of Number of Amenities Provided by Each List", y="Count",x="Number of Amenities")

```





# plots

```{r data}
data <- read_csv("./data/airbnb_201909.csv")
dim(data)

data%>%filter(last_review>='2018-09-01'&price>0&(!is.na(price)))%>%group_by(neighbourhood_group_cleansed)%>%summarise_all(function(x){sum(is.na(x))})%>%View()
```

```{r data cleaning}
#clean NA
completeFun <- function(data, desiredCols) {
  completeVec <- complete.cases(data[, desiredCols])
  return(data[completeVec, ])
}

data_cleaned <- completeFun(data, c("review_scores_value", "review_scores_checkin", "review_scores_accuracy", "review_scores_communication", "review_scores_cleanliness","review_scores_rating","neighbourhood", "review_scores_location", "price", "bedrooms", "beds","bathrooms", "host_identity_verified","zipcode"))

data_cleaned$cleaning_fee[is.na(data_cleaned$cleaning_fee)] <- 0
data_cleaned$security_deposit[is.na(data_cleaned$security_deposit)] <- 0
dim(data_cleaned) #37130    62#
#sort(colSums(is.na(data_cleaned)),decreasing = TRUE)

data_cleaned<-data_cleaned%>%filter(last_review>='2018-09-01' & price>0)
dim(data_cleaned) #28098

write_csv(data_cleaned,"data_cleaned.csv")
```

```{r missing}
library(extracat)

visna(data_cleaned)
##host_response_rate and host_response_time are missing together

data_cleaned%>%select(starts_with("host"))
unique(data_cleaned$host_response_time)
##suppose NA as no response


##13% service fee!!
```


```{r real price}
dat<-data_cleaned
dat<- dat%>%rowwise%>%
  mutate(price_full_pax = price + max(0,(accommodates-guests_included))*extra_people)%>%
  rowwise%>%
  mutate(price_full_pax_avg = price_full_pax/accommodates)%>%
  rowwise%>%
  mutate(price_1pax_avg = price)%>%
  rowwise%>%
  mutate(price_2pax_avg = ifelse(accommodates<2,NA,price+max(0,(2-guests_included))*extra_people) / 2)%>%
  rowwise%>%
  mutate(price_3pax_avg = ifelse(accommodates<3,NA,price+max(0,(3-guests_included))*extra_people) / 3)%>%
  rowwise%>%
  mutate(price_4pax_avg = ifelse(accommodates<4,NA,price+max(0,(4-guests_included))*extra_people) / 4)

ggplot(dat)+geom_histogram(aes(x=price_full_pax_avg))

```
## boxplot
```{r boxplot}
library(ggplot2)
dat1<-dat%>%filter(last_review>"2019-01-01")%>%
  dplyr::select(id,neighbourhood_group_cleansed,host_is_superhost,review_scores_rating,starts_with('price'))%>%
  dplyr::select(-price_full_pax)%>%
  gather(key="price_type",value="price_per_night",-id,-neighbourhood_group_cleansed,-host_is_superhost,-review_scores_rating)

ggplot(dat1)+
  geom_boxplot(aes(y=price_per_night, x=neighbourhood_group_cleansed,fill=host_is_superhost),varwidth =T)+
  facet_wrap(.~price_type, scales="free_y")

ggplot(dat1)+
  geom_boxplot(aes(y=price_per_night, x=neighbourhood_group_cleansed,fill=review_scores_rating==100),varwidth =T)+
  facet_wrap(.~price_type, scales="free_y")

```



## choreography map
```{r choreography map}

```

## diverging stacked bar chart
```{r diverging}

dat2<-dat%>%
  dplyr::select(id,neighbourhood_group_cleansed,host_is_superhost, review_scores_rating, host_response_time)%>%
  mutate(review = cut(review_scores_rating, breaks=c(100,99.9,95,90,80,0),
                      labels = c("ExtremeDisatisfied","Disatisfied","Neutral",
                                 "Satisfied","FullySatisfied")))

  mutate_at("host_response_time",fct_recode,levels=c("within an hour","within a few hours","within a day","a few days or more"))%>%
  mutate_at("host_response_time", fct_explicit_na,"No Response")


library(HH)
HH::likert(neighbourhood_group_cleansed~.,
           dat2%>%select(neighbourhood_group_cleansed,review)%>%group_by(neighbourhood_group_cleansed,review)%>%count()%>%ungroup%>%spread(key="review",value="n"),
           positive.order=TRUE,
           main="diverging",
           reference.line.col="gray65",
           as.percent=TRUE
           )

HH::likert(neighbourhood_group_cleansed~.,
           dat2%>%select(neighbourhood_group_cleansed,host_response_time)%>%group_by(neighbourhood_group_cleansed,host_response_time)%>%count()%>%ungroup%>%spread(key="host_response_time",value="n")%>%select(1,6,2:5),
           positive.order=TRUE,
           main="diverging",
           reference.line.col="gray65",
           as.percent=TRUE
           )

HH::likert(neighbourhood_group_cleansed~.|host_is_superhost,
           dat2%>%select(host_is_superhost,neighbourhood_group_cleansed,host_response_time)%>%group_by(host_is_superhost,neighbourhood_group_cleansed,host_response_time)%>%count()%>%ungroup%>%spread(key="host_response_time",value="n")%>%select(1:2,7,3:6),
           positive.order=TRUE,
           main="diverging",
           reference.line.col="gray65",
           as.percent=TRUE
           )
```